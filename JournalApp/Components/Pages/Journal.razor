@page "/journal"
@using JournalApp.Models
@using JournalApp.Services
@inject JournalService DbService
@inject IJSRuntime JS
@inject NavigationManager Nav

<!-- MAIN CONTAINER WITH SIDEBAR LAYOUT -->
<div class="journal-screen-dock">
    
    <!-- 1. LEFT SIDEBAR: Previous Notes -->
    <div class="journal-middle-list d-flex flex-column @(isSidebarOpen ? "" : "collapsed")">
        <div class="journal-list-content d-flex flex-column h-100 overflow-auto">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center gap-2">
                    <h3 class="fw-bold m-0 text-dark">Entries</h3>
                    
                    <!-- COLLAPSE BUTTON -->
                    <button class="btn btn-sm btn-link text-secondary p-0" 
                            @onclick="ToggleSidebar" 
                            title="Collapse Sidebar"
                            style="text-decoration: none;">
                        <i class="bi bi-layout-sidebar" style="font-size: 1.1rem;"></i>
                    </button>
                </div>

                <div class="d-flex gap-2">
                    <!-- SEARCH BUTTON -->
                    <button class="btn btn-sm btn-outline-dark btn-add-entry" @onclick="OpenSearch" title="Search (Cmd+K)">
                        <i class="bi bi-search" style="font-size: 0.9rem;"></i>
                    </button>
                    <!-- ADD BUTTON -->
                    <button class="btn btn-sm btn-outline-dark btn-add-entry" @onclick="CreateNew" title="New Entry">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            </div>

            <div class="d-flex flex-column gap-2">
                @if(pastEntries != null)
                {
                    @foreach(var entry in pastEntries)
                    {
                        bool isActive = entry.Id == currentEntry.Id;
                        
                        <div class="p-3 rounded-4 cursor-pointer sidebar-entry-item @(isActive ? "active" : "inactive")"
                             @onclick="() => LoadEntry(entry)">
                            <div class="fw-bold text-truncate text-dark">@(string.IsNullOrEmpty(entry.Title) ? "Untitled" : entry.Title)</div>
                            <div class="small opacity-75 d-flex justify-content-between text-secondary">
                                <span>@entry.EntryDate.ToString("MMM dd")</span>
                                <span>@(entry.PrimaryMood == "Happy" ? "üòä" : entry.PrimaryMood == "Sad" ? "üòî" : "")</span>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <!-- 2. RIGHT AREA: Editor -->
    <div class="journal-main-editor position-relative">
        
        <!-- EDITOR HEADER -->
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div class="d-flex align-items-center gap-3">
                <!-- EXPAND BUTTON -->
                @if (!isSidebarOpen)
                {
                    <button class="btn btn-sm btn-light border rounded-circle d-flex align-items-center justify-content-center shadow-sm" 
                            style="width: 35px; height: 35px;"
                            @onclick="ToggleSidebar" 
                            title="Show Entries">
                        <i class="bi bi-layout-sidebar-inset text-secondary"></i>
                    </button>
                }

                <div class="text-secondary small fw-bold text-uppercase letter-spacing-1">
                    @currentEntry.EntryDate.ToString("MMMM dd ‚Ä¢ dddd").ToUpper()
                </div>
            </div>
            
            <div class="d-flex gap-2 align-items-center">
                <!-- Mood Selection -->
                <div class="d-flex gap-1 me-3 align-items-center">
                    <span class="small text-muted me-2">Moods:</span>
                    @foreach(var mood in moods)
                    {
                        bool isPrimary = currentEntry.PrimaryMood == mood;
                        bool isSecondary = currentEntry.SecondaryMoods?.Split(',').Contains(mood) ?? false;
                        
                        <button class="btn btn-sm rounded-circle border d-flex align-items-center justify-content-center" 
                                style="@(isPrimary ? "background:#1A1A1A; color:white; border-color:#1A1A1A;" : isSecondary ? "background:#6c757d; color:white; border-color:#6c757d;" : "background:white; border-color:#E5E5E5;") width:35px; height:35px; transition:all 0.2s;"
                                @onclick="() => ToggleMood(mood)">
                            @(mood == "Happy" ? "üòä" : mood == "Neutral" ? "üòê" : "üòî")
                        </button>
                    }
                </div>

                <!-- Save Button -->
                <button class="btn btn-dark rounded-pill px-4 fw-bold shadow-sm" @onclick="SaveEntry">
                    <i class="bi bi-check2 me-2"></i> Save
                </button>
            </div>
        </div>

        <!-- VISUAL EDITOR CANVAS -->
        <!-- Logic: If sidebar open, max 900px. If collapsed, max 1200px. Smooth transition via style. -->
        <div class="flex-grow-1 mx-auto w-100" 
             style="max-width: @(isSidebarOpen ? "900px" : "1200px"); transition: max-width 0.4s ease; overflow-y: auto; padding-bottom: 80px;">
            
            @if (!isPreview)
            {
                <!-- Edit Mode -->
                <input type="text" 
                       class="w-100 border-0 bg-transparent fw-bold display-6 mb-4 zen-input text-dark" 
                       placeholder="Title your day..." 
                       @bind="currentEntry.Title" />
                
                <!-- CONTENTEDITABLE DIV -->
                <div id="richEditor"
                     class="rich-text-editor w-100" 
                     contenteditable="true"
                     placeholder="Start writing..." 
                     spellcheck="false">
                </div>
                          
                <input type="text" 
                       class="w-100 border-0 bg-transparent text-secondary mt-5 zen-input" 
                       style="font-size: 0.9rem;"
                       placeholder="#AddTags..." 
                       @bind="currentEntry.Tags" />
            }
            else
            {
                <!-- Preview Mode -->
                <div class="p-4 bg-white border rounded shadow-sm overflow-auto" style="height: 70vh; border-radius: 16px;">
                    <h1 class="fw-bold text-dark">@currentEntry.Title</h1>
                    <hr />
                    <div class="mt-3 fs-5 text-dark" style="white-space: pre-wrap; line-height: 1.8;">
                        @((MarkupString)(currentEntry.Content ?? ""))
                    </div>
                    <div class="mt-4">
                        @if(!string.IsNullOrEmpty(currentEntry.Tags))
                        {
                            @foreach(var tag in currentEntry.Tags.Split(','))
                            {
                                <span class="badge bg-secondary me-1">#@tag.Trim()</span>
                            }
                        }
                    </div>
                </div>
            }
        </div>

        <!-- FLOATING TOOLBAR -->
        @if (!isPreview)
        {
            <div class="position-absolute bottom-0 start-50 translate-middle-x pb-4 mb-2">
                <div class="d-flex align-items-center gap-4 px-4 py-2 rounded-pill shadow-sm bg-white border">
                    <i class="bi bi-type-bold text-dark cursor-pointer p-2" 
                       onmousedown="event.preventDefault();"
                       onclick="editorUtils.execCmd('bold');" 
                       title="Bold"></i>
                    
                    <i class="bi bi-type-italic text-secondary cursor-pointer p-2" 
                       onmousedown="event.preventDefault();"
                       onclick="editorUtils.execCmd('italic');" 
                       title="Italic"></i>
                    
                    <i class="bi bi-type-underline text-secondary cursor-pointer p-2" 
                       onmousedown="event.preventDefault();"
                       onclick="editorUtils.execCmd('underline');" 
                       title="Underline"></i>
                    
                    <div class="vr"></div>
                    
                    <button class="btn btn-link btn-sm text-decoration-none text-dark p-0 fw-bold" @onclick="TogglePreview">
                        PREVIEW
                    </button>
                </div>
            </div>
        }
        else
        {
            <div class="position-absolute bottom-0 start-50 translate-middle-x pb-4 mb-2">
                <button class="btn btn-dark rounded-pill px-4" @onclick="TogglePreview">
                    BACK TO EDIT
                </button>
            </div>
        }
    </div>
</div>

<!-- SPOTLIGHT SEARCH OVERLAY -->
<div class="spotlight-overlay @(showSearch ? "visible" : "")" @onclick="CloseSearch">
    <div class="spotlight-container" @onclick:stopPropagation>
        <div class="spotlight-bar">
            <i class="bi bi-search"></i>
            <input @ref="searchInput" 
                   class="spotlight-input" 
                   value="@searchQuery" 
                   @oninput="HandleSearchInput"
                   placeholder="Search your thoughts..." 
                   autofocus />
        </div>
        <div class="spotlight-results">
            @if(searchResults != null && searchResults.Any())
            {
                @foreach(var res in searchResults)
                {
                    <div class="spotlight-item" @onclick="() => SelectSearchResult(res)">
                        <div>
                            <div class="fw-bold text-dark">@(string.IsNullOrEmpty(res.Title) ? "Untitled" : res.Title)</div>
                            <small class="text-muted">@res.EntryDate.ToString("MMM dd, yyyy")</small>
                        </div>
                        <div class="text-secondary small">
                            <i class="bi bi-arrow-return-left"></i>
                        </div>
                    </div>
                }
            }
            else if (!string.IsNullOrEmpty(searchQuery))
            {
                <div class="p-3 text-muted text-center small">No matches found.</div>
            }
        </div>
    </div>
</div>

<style>
    .zen-input { 
        outline: none !important; 
        box-shadow: none !important;
        background-color: transparent !important;
    }
    .zen-input::placeholder { color: #ccc; }
    .cursor-pointer { cursor: pointer; }
    .letter-spacing-1 { letter-spacing: 1px; }
    .transition-base { transition: all 0.2s ease; }
    
    .journal-list-content::-webkit-scrollbar { width: 5px; }
    .journal-list-content::-webkit-scrollbar-thumb { background: #bbb; border-radius: 10px; }
    
    .bi-type-bold:hover, .bi-type-italic:hover, .bi-type-underline:hover {
        background-color: #f0f0f0;
        border-radius: 5px;
    }
</style>

@code {
    [SupplyParameterFromQuery]
    public string? Date { get; set; }

    private JournalEntry currentEntry = new JournalEntry { EntryDate = DateTime.Now };
    private List<JournalEntry> pastEntries = new();
    private string[] moods = { "Happy", "Neutral", "Sad" };
    private bool isPreview = false;
    private bool isSidebarOpen = true; 
    private bool shouldRenderEditorContent = true;

    // --- SEARCH STATE ---
    private bool showSearch = false;
    private string searchQuery = "";
    private List<JournalEntry> searchResults = new();
    private ElementReference searchInput;

    protected override async Task OnInitializedAsync()
    {
        await LoadList();
        
        DateTime targetDate = DateTime.Now;
        if (!string.IsNullOrEmpty(Date) && DateTime.TryParse(Date, out DateTime parsedDate))
        {
            targetDate = parsedDate;
        }
        
        await LoadEntryByDate(targetDate);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (shouldRenderEditorContent && !isPreview)
        {
            await JS.InvokeVoidAsync("editorUtils.setHtml", "richEditor", currentEntry.Content);
            shouldRenderEditorContent = false;
        }
        
        // Auto-focus search input when opened
        if (showSearch)
        {
            await searchInput.FocusAsync();
        }
    }

    private void ToggleSidebar()
    {
        isSidebarOpen = !isSidebarOpen;
    }

    // --- SEARCH LOGIC ---
    private void OpenSearch()
    {
        searchQuery = "";
        searchResults.Clear();
        showSearch = true;
        StateHasChanged();
    }

    private void CloseSearch()
    {
        showSearch = false;
    }

    private void HandleSearchInput(ChangeEventArgs e)
    {
        searchQuery = e.Value?.ToString() ?? "";
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            searchResults.Clear();
        }
        else
        {
            searchResults = pastEntries
                .Where(x => (x.Title?.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ?? false) || 
                            (x.Content?.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(5)
                .ToList();
        }
    }

    private async Task SelectSearchResult(JournalEntry entry)
    {
        await LoadEntry(entry);
        CloseSearch();
    }

    // --- EXISTING LOGIC ---

    private async Task LoadList()
    {
        pastEntries = await DbService.GetAllEntriesAsync();
    }

    private async Task LoadEntryByDate(DateTime date)
    {
        var existing = await DbService.GetEntryByDateAsync(date);
        if (existing != null) currentEntry = existing;
        else currentEntry = new JournalEntry { EntryDate = date };
        
        shouldRenderEditorContent = true; 
        StateHasChanged();
    }

    private async Task LoadEntry(JournalEntry entry)
    {
        currentEntry = entry;
        isPreview = false;
        shouldRenderEditorContent = true;
        StateHasChanged();
    }

    private void CreateNew()
    {
        currentEntry = new JournalEntry { EntryDate = DateTime.Now };
        isPreview = false;
        shouldRenderEditorContent = true;
        StateHasChanged();
    }

    private async Task TogglePreview()
    {
        if (!isPreview)
        {
            string htmlContent = await JS.InvokeAsync<string>("editorUtils.getHtml", "richEditor");
            currentEntry.Content = htmlContent;
        }
        
        isPreview = !isPreview;
        shouldRenderEditorContent = true;
    }

    private void ToggleMood(string mood)
    {
        if (string.IsNullOrEmpty(currentEntry.PrimaryMood)) currentEntry.PrimaryMood = mood;
        else if (currentEntry.PrimaryMood == mood) currentEntry.PrimaryMood = string.Empty;
        else
        {
            var secondaryList = string.IsNullOrEmpty(currentEntry.SecondaryMoods) 
                ? new List<string>() 
                : currentEntry.SecondaryMoods.Split(',').ToList();

            if (secondaryList.Contains(mood)) secondaryList.Remove(mood);
            else if (secondaryList.Count < 2) secondaryList.Add(mood);
            
            currentEntry.SecondaryMoods = string.Join(",", secondaryList);
        }
    }

    private async Task SaveEntry()
    {
        try 
        {
            string htmlContent = await JS.InvokeAsync<string>("editorUtils.getHtml", "richEditor");
            currentEntry.Content = htmlContent;

            await DbService.SaveEntryAsync(currentEntry);
            
            await LoadList();
            await JS.InvokeVoidAsync("alert", "Journal saved successfully!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "Error saving: " + ex.Message);
        }
    }
}