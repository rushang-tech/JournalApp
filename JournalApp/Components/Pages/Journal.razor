@page "/journal"
@using JournalApp.Models
@using JournalApp.Services
@inject JournalService DbService
@inject IJSRuntime JS
@inject NavigationManager Nav

<div class="journal-screen-dock">

    <!-- 1. LEFT SIDEBAR: Entry List -->
    <div class="journal-middle-list @(isSidebarOpen ? "" : "collapsed")">

        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <h3 class="sidebar-title">Entries</h3>
            <div class="sidebar-actions">
                <button class="icon-btn" @onclick="OpenSearch" title="Search">
                    <i class="bi bi-search"></i>
                </button>
                <button class="icon-btn" @onclick="CreateNew" title="Today's Entry">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <button class="icon-btn" @onclick="ToggleSidebar" title="Collapse">
                    <i class="bi bi-layout-sidebar"></i>
                </button>
            </div>
        </div>

        <!-- Entry List -->
        <div class="entry-list-container">
            @if(pastEntries != null)
            {
            @foreach(var entry in pastEntries)
            {
            bool isActive = entry.Id == currentEntry.Id && entry.Id != 0;

            <div class="sidebar-entry-item @(isActive ? "active" : "")" @onclick="() => LoadEntry(entry)">
                <div class="entry-item-title">
                    @(string.IsNullOrEmpty(entry.Title) ? "Untitled" : entry.Title)
                </div>
                <div class="entry-item-meta">
                    <span>@entry.EntryDate.ToString("MMM dd")</span>
                    <span>@GetMoodEmoji(entry.PrimaryMood)</span>
                </div>
            </div>
            }
            }
        </div>
    </div>

    <!-- 2. RIGHT AREA: Editor -->
    <div class="journal-main-editor">

        <!-- Editor Header -->
        <div class="editor-header">
            <div class="d-flex align-items-center gap-3">
                @if (!isSidebarOpen)
                {
                <button class="icon-btn" @onclick="ToggleSidebar" title="Open Sidebar">
                    <i class="bi bi-layout-sidebar-inset"></i>
                </button>
                }
                <div class="date-display">
                    @currentEntry.EntryDate.ToString("MMMM dd â€¢ dddd").ToUpper()
                </div>
            </div>

            <div class="editor-actions">

                <!-- Mood Selection -->
                <div class="mood-container">
                    <div class="mood-selector @(triggerShake ? "shake-animation" : "")">
                        @foreach(var mood in moods)
                        {
                        bool isSelected = currentEntry.PrimaryMood == mood;
                        <!-- ASYNC TOGGLE to save text state -->
                        <button class="mood-btn @(isSelected ? "selected" : "")"
                                @onclick="() => ToggleMood(mood)">
                            @GetMoodEmoji(mood)
                        </button>
                        }
                    </div>
                    @if (showMoodError)
                    {
                    <div class="mood-error-popup">Select a mood!</div>
                    }
                </div>

                <!-- Delete Button -->
                @if(currentEntry.Id != 0)
                {
                <button class="icon-btn danger" @onclick="DeleteCurrentEntry" title="Delete">
                    <i class="bi bi-trash3"></i>
                </button>
                }

                <!-- Save Button -->
                <button class="save-btn" @onclick="SaveEntry">
                    <i class="bi bi-check2"></i> Save
                </button>
            </div>
        </div>

        <!-- Editor Canvas -->
        <!-- Added 'expanded' class logic here based on sidebar state -->
        <div class="editor-canvas @(isSidebarOpen ? "" : "expanded")">
            <!-- Title Input -->
            <input type="text"
                   class="title-input"
                   placeholder="Title your day..."
                   @bind="currentEntry.Title" />

            <!-- Rich Text Editor: Fills remaining space -->
            <div id="richEditor"
                 class="rich-text-editor"
                 contenteditable="true"
                 placeholder="Start writing..."
                 spellcheck="false">
            </div>

            <!-- Tags Input -->
            <input type="text"
                   class="tags-input"
                   placeholder="#AddTags (e.g. #Work, #Gratitude)..."
                   @bind="currentEntry.Tags" />
        </div>

        <!-- Formatting Toolbar -->
        <div class="formatting-toolbar">
            <button class="format-btn" onmousedown="event.preventDefault();" onclick="editorUtils.execCmd('bold')" title="Bold"><i class="bi bi-type-bold"></i></button>
            <button class="format-btn" onmousedown="event.preventDefault();" onclick="editorUtils.execCmd('italic')" title="Italic"><i class="bi bi-type-italic"></i></button>
            <button class="format-btn" onmousedown="event.preventDefault();" onclick="editorUtils.execCmd('underline')" title="Underline"><i class="bi bi-type-underline"></i></button>
            <button class="format-btn" onmousedown="event.preventDefault();" onclick="editorUtils.execCmd('insertUnorderedList')" title="Bullet List"><i class="bi bi-list-ul"></i></button>
        </div>
    </div>
</div>

<!-- SPOTLIGHT SEARCH OVERLAY -->
<div class="spotlight-overlay @(showSearch ? "visible" : "")" @onclick="CloseSearch">
    <div class="spotlight-container" @onclick:stopPropagation>
        <div class="spotlight-bar">
            <i class="bi bi-search"></i>
            <input @ref="searchInput"
                   class="spotlight-input"
                   value="@searchQuery"
                   @oninput="HandleSearchInput"
                   placeholder="Search your thoughts..."
                   autofocus />
        </div>
        <div class="spotlight-results">
            @if(searchResults.Any())
            {
            @foreach(var res in searchResults)
            {
            <div class="spotlight-item" @onclick="() => SelectSearchResult(res)">
                <div>
                    <div class="fw-bold">@(string.IsNullOrEmpty(res.Title) ? "Untitled" : res.Title)</div>
                    <small class="opacity-75">@res.EntryDate.ToString("MMM dd, yyyy")</small>
                </div>
                <i class="bi bi-arrow-return-left"></i>
            </div>
            }
            }
        </div>
    </div>
</div>

@code {
[SupplyParameterFromQuery] public string? Date { get; set; }

private JournalEntry currentEntry = new JournalEntry { EntryDate = DateTime.Now };
private List<JournalEntry> pastEntries = new();
private string[] moods = { "Happy", "Neutral", "Sad" };
private bool isSidebarOpen = true;

// Validation State
private bool triggerShake = false;
private bool showMoodError = false;

// Search State
private bool showSearch = false;
private string searchQuery = "";
private List<JournalEntry> searchResults = new();
private ElementReference searchInput;

protected override async Task OnInitializedAsync()
{
await LoadList();

if (!string.IsNullOrEmpty(Date) && DateTime.TryParse(Date, out DateTime parsedDate))
{
await LoadEntryByDate(parsedDate);
}
else
{
await CreateNew();
}
}

protected override async Task OnAfterRenderAsync(bool firstRender)
{
if (firstRender)
{
await JS.InvokeVoidAsync("editorUtils.setHtml", "richEditor", currentEntry.Content);
}
if (showSearch) await searchInput.FocusAsync();
}

private async Task LoadList() => pastEntries = await DbService.GetAllEntriesAsync();

private async Task LoadEntryByDate(DateTime date)
{
if(currentEntry.Id != 0) await SaveEntryWithoutValidation();

var existing = await DbService.GetEntryByDateAsync(date);

currentEntry = existing ?? new JournalEntry { EntryDate = date };

await JS.InvokeVoidAsync("editorUtils.setHtml", "richEditor", currentEntry.Content);
ResetValidation();
}

private async Task LoadEntry(JournalEntry entry)
{
if(currentEntry.Id != 0) await SaveEntryWithoutValidation();

currentEntry = entry;
await JS.InvokeVoidAsync("editorUtils.setHtml", "richEditor", currentEntry.Content);
ResetValidation();
}

// --- ONE ENTRY PER DAY LOGIC ---
private async Task CreateNew()
{
var today = DateTime.Today;
var existingToday = await DbService.GetEntryByDateAsync(today);

if (existingToday != null)
{
currentEntry = existingToday;
}
else
{
currentEntry = new JournalEntry { EntryDate = DateTime.Now };
}

await JS.InvokeVoidAsync("editorUtils.setHtml", "richEditor", currentEntry.Content ?? "");
ResetValidation();
}

private void ResetValidation()
{
triggerShake = false;
showMoodError = false;
}

private void ToggleSidebar() => isSidebarOpen = !isSidebarOpen;

// --- TEXT STATE PRESERVATION FIX ---
private async Task ToggleMood(string mood)
{
string currentHtml = await JS.InvokeAsync<string>("editorUtils.getHtml", "richEditor");
currentEntry.Content = currentHtml;

if (currentEntry.PrimaryMood == mood)
{
currentEntry.PrimaryMood = "";
}
else
{
currentEntry.PrimaryMood = mood;
ResetValidation();
}

StateHasChanged();
}

private string GetMoodEmoji(string? mood) => mood switch { "Happy" => "ðŸ˜Š", "Sad" => "ðŸ˜”", "Neutral" => "ðŸ˜", _ => "" };

private async Task SaveTextState()
{
currentEntry.Content = await JS.InvokeAsync<string>("editorUtils.getHtml", "richEditor");
}

private async Task SaveEntry()
{
if (string.IsNullOrEmpty(currentEntry.PrimaryMood))
{
triggerShake = true;
showMoodError = true;
StateHasChanged();
await Task.Delay(500);
triggerShake = false;
StateHasChanged();
return;
}

await SaveEntryWithoutValidation();
await JS.InvokeVoidAsync("alert", "Saved successfully!");
}

private async Task SaveEntryWithoutValidation()
{
currentEntry.Content = await JS.InvokeAsync<string>("editorUtils.getHtml", "richEditor");
await DbService.SaveEntryAsync(currentEntry);
await LoadList();
}

private async Task DeleteCurrentEntry()
{
if (currentEntry.Id == 0) return;
bool confirmed = await JS.InvokeAsync<bool>("confirm", "Delete this entry?");
if (confirmed)
{
await DbService.DeleteEntryAsync(currentEntry);
await LoadList();
await CreateNew();
}
}

// Search Logic
private void OpenSearch() { searchQuery = ""; searchResults.Clear(); showSearch = true; }
private void CloseSearch() => showSearch = false;
private void HandleSearchInput(ChangeEventArgs e)
{
searchQuery = e.Value?.ToString() ?? "";
if (!string.IsNullOrWhiteSpace(searchQuery))
{
searchResults = pastEntries.Where(x => (x.Title?.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ?? false) || (x.Content?.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ?? false)).Take(5).ToList();
}
}
private async Task SelectSearchResult(JournalEntry entry) { await LoadEntry(entry); CloseSearch(); }
}

<style>
    /* --- FIXED LAYOUT STRUCTURE --- */
    .journal-screen-dock {
        display: flex;
        flex-direction: row;
        height: 100vh;
        width: 100%;
        overflow: hidden;
        background-color: var(--bg-primary);
        position: relative;
    }

    /* --- SIDEBAR --- */
    .journal-middle-list {
        width: 300px;
        background-color: var(--bg-secondary);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 25px;
        transition: width 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
        flex-shrink: 0;
        z-index: 5;
    }

    .journal-middle-list.collapsed {
        width: 0; padding: 25px 0; opacity: 0; border: none; overflow: hidden;
    }

    .sidebar-header {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;
    }
    .sidebar-title {
        font-size: 1.5rem; font-weight: 800; margin: 0; color: var(--text-primary);
    }
    .sidebar-actions { display: flex; gap: 8px; }

    .icon-btn {
        background: transparent; border: 1px solid var(--border-color);
        color: var(--text-secondary); border-radius: 50%;
        width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s;
    }
    .icon-btn:hover { background-color: var(--hover-bg); color: var(--text-primary); }
    .icon-btn.danger:hover { background-color: #fee2e2; color: #dc2626; border-color: #fee2e2; }

    .entry-list-container {
        flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
    }

    .sidebar-entry-item {
        padding: 16px; border-radius: 16px; cursor: pointer;
        background-color: transparent; border: 1px solid transparent;
        transition: all 0.2s;
    }
    .sidebar-entry-item:hover { background-color: var(--hover-bg); }
    .sidebar-entry-item.active {
        background-color: var(--bg-tertiary);
        border-color: var(--border-color);
    }

    .entry-item-title { font-weight: 700; color: var(--text-primary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .entry-item-meta { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary); }

    /* --- EDITOR AREA (Fixed Height Logic) --- */
    .journal-main-editor {
        flex: 1;
        background-color: var(--bg-primary);
        display: flex; flex-direction: column;
        position: relative;
        height: 100vh; /* Force full height */
        overflow: hidden;
    }

    .editor-header {
        padding: 25px 40px;
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 1px solid transparent;
        flex-shrink: 0;
    }

    .date-display {
        font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 1px;
    }

    .editor-actions { display: flex; align-items: center; gap: 15px; }

    /* --- CANVAS & INPUTS (Dynamic Expansion) --- */
    .editor-canvas {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        padding: 20px 80px 80px 80px;
        overflow-y: auto;

        /* STANDARD WIDTH */
        max-width: 900px;
        width: 100%;
        margin: 0 auto;

        transition: max-width 0.4s ease, padding 0.4s ease;
    }

    /* EXPANDED STATE (Triggered when sidebar collapsed) */
    .editor-canvas.expanded {
        max-width: 1600px; /* Expands to fill screen */
    }

    .title-input {
        width: 100%; border: none; background: transparent;
        font-size: 3rem; font-weight: 900; color: var(--text-primary);
        margin-bottom: 30px; outline: none;
        flex-shrink: 0;
    }
    .title-input::placeholder { color: var(--text-muted); opacity: 0.5; }

    /* EDITOR SIZE */
    .rich-text-editor {
        width: 100%;
        flex-grow: 1; /* Stretch to fill vertical void */
        min-height: 500px;
        outline: none;
        font-size: 1.25rem; line-height: 1.8; color: var(--text-primary);
        white-space: pre-wrap;
    }

    .rich-text-editor:empty:before {
        content: attr(placeholder); color: var(--text-muted); display: block;
    }

    .rich-text-editor ul { padding-left: 20px; margin-bottom: 10px; }
    .rich-text-editor li { margin-bottom: 5px; }

    .tags-input {
        width: 100%; border: none; background: transparent;
        margin-top: 40px; color: var(--text-secondary); font-size: 1rem;
        flex-shrink: 0;
        padding-bottom: 40px;
    }

    /* --- MOOD & TOOLBAR STYLES --- */
    .mood-container { position: relative; }

    .mood-selector {
        display: flex; gap: 5px; background: var(--bg-secondary);
        padding: 4px; border-radius: 50px; border: 1px solid var(--border-color);
    }

    .shake-animation {
        animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        border-color: #dc3545 !important;
    }

    @@keyframes shake {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        40%, 60% { transform: translate3d(4px, 0, 0); }
    }

    .mood-error-popup {
        position: absolute; top: 45px; right: 0;
        background-color: #dc3545; color: white;
        font-size: 0.75rem; font-weight: 700;
        padding: 4px 10px; border-radius: 6px;
        white-space: nowrap; animation: fadeIn 0.2s;
        z-index: 10;
    }
    .mood-error-popup::before {
        content: ""; position: absolute; top: -4px; right: 20px;
        width: 8px; height: 8px; background-color: #dc3545;
        transform: rotate(45deg);
    }

    .mood-btn {
        background: transparent; border: none; width: 32px; height: 32px; border-radius: 50%;
        cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
    }
    .mood-btn:hover { background-color: var(--hover-bg); transform: scale(1.1); }
    .mood-btn.selected { background-color: var(--accent-color); color: var(--accent-text); transform: scale(1.1); }

    .save-btn {
        background-color: var(--text-primary); color: var(--bg-primary);
        border: none; padding: 8px 24px; border-radius: 50px;
        font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
    }
    .save-btn:hover { opacity: 0.9; }

    /* --- FLOATING TOOLBAR --- */
    .formatting-toolbar {
        position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
        background-color: var(--bg-secondary); border: 1px solid var(--border-color);
        padding: 10px 20px; border-radius: 50px; display: flex; gap: 20px;
        box-shadow: 0 5px 20px var(--shadow-color);
        z-index: 10;
    }
    .format-btn {
        background: none; border: none; color: var(--text-primary);
        font-size: 1.2rem; cursor: pointer; transition: color 0.2s;
    }
    .format-btn:hover { color: #512BD4; }

    /* --- SEARCH OVERLAY --- */
    .spotlight-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        z-index: 100; display: flex; justify-content: center; padding-top: 15vh;
        opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .spotlight-overlay.visible { opacity: 1; pointer-events: auto; }

    .spotlight-container {
        width: 600px; background: var(--bg-secondary);
        border-radius: 16px; overflow: hidden;
        box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 1px solid var(--border-color);
        display: flex; flex-direction: column; max-height: 400px;
    }
    .spotlight-bar {
        display: flex; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-color);
    }
    .spotlight-bar i { font-size: 1.5rem; color: var(--text-muted); margin-right: 15px; }
    .spotlight-input {
        flex: 1; background: transparent; border: none; font-size: 1.5rem; color: var(--text-primary);
    }
    .spotlight-results { overflow-y: auto; padding: 10px; }
    .spotlight-item {
        padding: 15px; display: flex; justify-content: space-between; align-items: center;
        border-radius: 10px; cursor: pointer; color: var(--text-primary);
    }
    .spotlight-item:hover { background-color: var(--hover-bg); }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
</style>