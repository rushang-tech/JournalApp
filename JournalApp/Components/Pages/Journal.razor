@page "/journal"
@using JournalApp.Models
@using JournalApp.Services
@inject JournalService DbService
@inject IJSRuntime JS
@inject NavigationManager Nav

<div class="journal-container">
    
    <!-- LEFT SIDEBAR: Navigation & History -->
    <div class="journal-sidebar">
        <div class="sidebar-header">
            <h3 class="fw-bold mb-3">My Journal</h3>
            
            <!-- Requirement: Search -->
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" placeholder="Search..." @bind="searchText" @bind:after="PerformSearch" />
            </div>

            <!-- Requirement: Filter by Mood -->
            <select class="mood-filter" @onchange="FilterByMood">
                <option value="">All Moods</option>
                <option value="Happy">Happy üòä</option>
                <option value="Neutral">Neutral üòê</option>
                <option value="Sad">Sad üòî</option>
            </select>
        </div>

        <div class="entry-list">
            <button class="btn-create-new" @onclick="CreateNew">
                <i class="bi bi-plus-lg"></i> Create New Entry
            </button>

            @if (displayedEntries != null)
            {
                @foreach (var entry in displayedEntries)
                {
                    bool isActive = entry.Id == currentEntry.Id;
                    <div class="entry-card @(isActive ? "active" : "")" @onclick="() => LoadEntry(entry)">
                        <div class="entry-date">@entry.EntryDate.ToString("MMM dd, yyyy")</div>
                        <div class="entry-title">@(string.IsNullOrEmpty(entry.Title) ? "Untitled" : entry.Title)</div>
                        
                        @if(!string.IsNullOrEmpty(entry.PrimaryMood))
                        {
                            <div class="entry-mood-badge">
                                @(entry.PrimaryMood == "Happy" ? "üòä" : entry.PrimaryMood == "Neutral" ? "üòê" : "üòî")
                            </div>
                        }
                    </div>
                }
            }

            <!-- Requirement: Pagination -->
            <button class="btn-load-more" @onclick="LoadMoreEntries">
                Load More...
            </button>
        </div>
    </div>

    <!-- RIGHT CONTENT: Editor -->
    <div class="journal-editor-area">
        
        <!-- Header: Date, Moods, Save -->
        <div class="editor-header">
            <div>
                <div class="editor-date">@currentEntry.EntryDate.ToString("dddd, MMMM dd, yyyy")</div>
                <div class="editor-time text-muted small">@currentEntry.EntryDate.ToString("h:mm tt")</div>
            </div>

            <div class="editor-actions">
                <!-- Requirement: Mood Tracking -->
                <div class="mood-selector">
                    @foreach(var mood in moods)
                    {
                        bool isPrimary = currentEntry.PrimaryMood == mood;
                        bool isSecondary = currentEntry.SecondaryMoods?.Contains(mood) ?? false;
                        string btnClass = isPrimary ? "mood-primary" : (isSecondary ? "mood-secondary" : "mood-outline");

                        <button class="mood-btn @btnClass" @onclick="() => ToggleMood(mood)" title="@mood">
                            @(mood == "Happy" ? "üòä" : mood == "Neutral" ? "üòê" : "üòî")
                        </button>
                    }
                </div>

                <div class="vr mx-3"></div>

                @if(currentEntry.Id != 0)
                {
                    <button class="action-btn text-danger" @onclick="DeleteCurrent" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                }
                <button class="btn-save" @onclick="SaveEntry">Save</button>
            </div>
        </div>

        <!-- Requirement: Rich Text Toolbar (Top) -->
        <!-- This ID links to Quill JS -->
        <div id="toolbar-container" class="quill-toolbar">
            <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
                <button class="ql-strike"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-header" value="1"></button>
                <button class="ql-header" value="2"></button>
                <button class="ql-blockquote"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-clean"></button>
            </span>
        </div>

        <!-- Editor Canvas -->
        <div class="editor-wrapper">
            <input type="text" class="title-input" placeholder="Title your entry..." @bind="currentEntry.Title" />
            
            <!-- Quill Editor Mount Point -->
            <div id="editor-container"></div>
        </div>

        <!-- Requirement: Tags -->
        <div class="editor-footer">
            <div class="tags-container">
                <i class="bi bi-tags-fill text-muted me-2"></i>
                <input type="text" class="tags-input" placeholder="Tags (comma separated)..." @bind="currentEntry.Tags" />
            </div>
        </div>

    </div>
</div>

<style>
    /* --- RESET & LAYOUT --- */
    .journal-container {
        display: flex;
        width: 100%;
        height: 100vh;
        background-color: #F5F5F5;
        font-family: 'Poppins', sans-serif;
        /* Reset any previous negative margins */
        margin: 0; 
        overflow: hidden;
    }

    /* --- SIDEBAR --- */
    .journal-sidebar {
        width: 300px;
        min-width: 300px;
        background-color: #FFFFFF;
        border-right: 1px solid #E0E0E0;
        display: flex;
        flex-direction: column;
        z-index: 2;
        box-shadow: 2px 0 5px rgba(0,0,0,0.02);
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #F0F0F0;
        background: #FAFAFA;
    }

    .search-box {
        background: #FFF; border: 1px solid #DDD; border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
    }
    .search-box input { border: none; outline: none; width: 100%; font-size: 14px; }
    
    .mood-filter { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #DDD; background: #FFF; font-size: 14px; color: #555; }

    .entry-list {
        flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;
    }

    .btn-create-new {
        background: #1A1A1A; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 10px;
    }
    .btn-create-new:hover { opacity: 0.9; }

    .entry-card {
        background: #FFF; border: 1px solid #EEE; border-radius: 8px; padding: 12px; cursor: pointer; position: relative; transition: 0.1s;
    }
    .entry-card:hover { background: #F9F9F9; border-color: #CCC; }
    .entry-card.active { border-left: 4px solid #1A1A1A; background: #F4F4F4; }

    .entry-date { font-size: 12px; color: #888; font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
    .entry-title { font-size: 15px; font-weight: 700; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .entry-mood-badge { position: absolute; top: 12px; right: 12px; font-size: 14px; }

    .btn-load-more { background: none; border: none; color: #666; text-decoration: underline; cursor: pointer; padding: 10px; font-size: 13px; }

    /* --- EDITOR AREA --- */
    .journal-editor-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #FFFFFF;
        height: 100%;
    }

    .editor-header {
        padding: 15px 30px;
        border-bottom: 1px solid #F0F0F0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #FFF;
    }

    .editor-date { font-size: 18px; font-weight: 700; color: #1A1A1A; }
    .editor-actions { display: flex; align-items: center; gap: 15px; }

    /* Mood Buttons */
    .mood-selector { display: flex; gap: 5px; }
    .mood-btn {
        width: 35px; height: 35px; border-radius: 50%; border: 1px solid transparent; background: transparent; font-size: 1.2rem; cursor: pointer; transition: 0.2s;
    }
    .mood-primary { background: #1A1A1A; border-color: #1A1A1A; transform: scale(1.1); }
    .mood-secondary { background: #E0E0E0; border-color: #CCC; }
    .mood-outline { border-color: #EEE; opacity: 0.4; filter: grayscale(100%); }
    .mood-outline:hover { opacity: 1; background: #F9F9F9; }

    .btn-save { background: #1A1A1A; color: white; border: none; padding: 8px 24px; border-radius: 20px; font-weight: 600; cursor: pointer; }
    .action-btn { background: none; border: none; font-size: 20px; cursor: pointer; }

    /* Quill Toolbar */
    .quill-toolbar {
        border-bottom: 1px solid #EEE !important;
        background: #FAFAFA;
        padding: 8px 30px !important;
    }
    .ql-toolbar.ql-snow { border: none !important; }

    /* Content Wrapper */
    .editor-wrapper {
        flex: 1;
        overflow-y: auto;
        padding: 30px 50px;
        display: flex;
        flex-direction: column;
    }

    .title-input {
        font-size: 32px; font-weight: 800; border: none; outline: none; width: 100%; margin-bottom: 20px; color: #1A1A1A;
    }
    .title-input::placeholder { color: #CCC; }

    /* Quill Editor Adjustments */
    #editor-container {
        flex: 1;
        font-size: 18px;
        line-height: 1.8;
        color: #333;
        min-height: 300px;
    }
    .ql-container.ql-snow { border: none !important; font-family: 'Poppins', sans-serif !important; }
    .ql-editor { padding: 0 !important; }
    .ql-editor.ql-blank::before { font-style: normal; color: #BBB; }

    /* Footer */
    .editor-footer {
        padding: 15px 30px;
        border-top: 1px solid #F0F0F0;
        background: #FAFAFA;
    }
    .tags-container {
        display: flex; align-items: center; background: white; border: 1px solid #DDD; padding: 8px 15px; border-radius: 8px;
    }
    .tags-input { border: none; outline: none; width: 100%; font-size: 14px; }
</style>

@code {
    [SupplyParameterFromQuery]
    public string? Date { get; set; }

    private JournalEntry currentEntry = new JournalEntry { EntryDate = DateTime.Now };
    private List<JournalEntry> displayedEntries = new();
    private string[] moods = { "Happy", "Neutral", "Sad" };
    private string searchText = "";
    private string moodFilter = "";
    private int pageSize = 15;
    private int currentPage = 0;
    
    // JS Interop Reference
    private DotNetObjectReference<object>? objRef;

    protected override async Task OnInitializedAsync()
    {
        objRef = DotNetObjectReference.Create((object)this);
        await LoadSidebar(reset: true);
        
        DateTime targetDate = DateTime.Now;
        if (!string.IsNullOrEmpty(Date) && DateTime.TryParse(Date, out DateTime parsedDate))
        {
            targetDate = parsedDate;
            var existing = await DbService.GetEntryByDateAsync(targetDate);
            if (existing != null) currentEntry = existing;
            else currentEntry = new JournalEntry { EntryDate = targetDate };
        }
        else if (displayedEntries.Any())
        {
            currentEntry = displayedEntries.First();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(200); 
            await JS.InvokeVoidAsync("initQuill", objRef, currentEntry.Content);
        }
    }

    [JSInvokable]
    public void UpdateContent(string htmlContent)
    {
        currentEntry.Content = htmlContent;
    }

    private async Task LoadSidebar(bool reset = false)
    {
        if (reset) { currentPage = 0; displayedEntries.Clear(); }
        var newBatch = await DbService.GetEntriesPagedAsync(currentPage * pageSize, pageSize);
        if (newBatch.Any())
        {
            displayedEntries.AddRange(newBatch);
            currentPage++;
        }
    }

    private async Task LoadMoreEntries() => await LoadSidebar(reset: false);

    private async Task PerformSearch()
    {
        var all = await DbService.GetAllEntriesAsync();
        IEnumerable<JournalEntry> query = all;

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            query = query.Where(e => 
                (e.Title != null && e.Title.Contains(searchText, StringComparison.OrdinalIgnoreCase)) || 
                (e.Content != null && e.Content.Contains(searchText, StringComparison.OrdinalIgnoreCase)));
        }
        if (!string.IsNullOrWhiteSpace(moodFilter))
        {
            query = query.Where(e => e.PrimaryMood == moodFilter || (e.SecondaryMoods != null && e.SecondaryMoods.Contains(moodFilter)));
        }
        displayedEntries = query.ToList();
    }

    private async Task FilterByMood(ChangeEventArgs e)
    {
        moodFilter = e.Value?.ToString() ?? "";
        await PerformSearch();
    }

    private async Task LoadEntry(JournalEntry entry)
    {
        currentEntry = entry;
        await JS.InvokeVoidAsync("setQuillContent", currentEntry.Content);
    }

    private async Task CreateNew()
    {
        currentEntry = new JournalEntry { EntryDate = DateTime.Now };
        await JS.InvokeVoidAsync("setQuillContent", "");
    }

    private void ToggleMood(string mood)
    {
        if (currentEntry.PrimaryMood == mood) currentEntry.PrimaryMood = string.Empty;
        else if (string.IsNullOrEmpty(currentEntry.PrimaryMood)) currentEntry.PrimaryMood = mood;
        else
        {
            var secs = string.IsNullOrEmpty(currentEntry.SecondaryMoods) ? new List<string>() : currentEntry.SecondaryMoods.Split(',').ToList();
            if (secs.Contains(mood)) secs.Remove(mood);
            else if (secs.Count < 2) secs.Add(mood);
            currentEntry.SecondaryMoods = string.Join(",", secs);
        }
    }

    private async Task SaveEntry()
    {
        try {
            await DbService.SaveEntryAsync(currentEntry);
            await PerformSearch(); 
            await JS.InvokeVoidAsync("alert", "Saved!");
        }
        catch (Exception ex) { await JS.InvokeVoidAsync("alert", ex.Message); }
    }

    private async Task DeleteCurrent()
    {
        if (await JS.InvokeAsync<bool>("confirm", "Delete?")) {
            await DbService.DeleteEntryAsync(currentEntry);
            await LoadSidebar(reset: true);
            if (displayedEntries.Any()) await LoadEntry(displayedEntries.First());
            else await CreateNew();
        }
    }

    private string StripHtml(string input)
    {
        if (string.IsNullOrEmpty(input)) return "";
        return System.Text.RegularExpressions.Regex.Replace(input, "<.*?>", String.Empty);
    }

    public void Dispose() { objRef?.Dispose(); }
}