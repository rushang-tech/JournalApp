@page "/calendar"
@using System.Globalization
@using JournalApp.Services
@using JournalApp.Models
@inject JournalService DbService
@inject NavigationManager Nav

<div class="calendar-wrapper">
    
    <!-- 1. Header (Month Navigation) -->
    <div class="header-row">
        <h1 class="page-title">Calendar</h1>
        
        <div class="month-selector">
            <button class="nav-btn" @onclick="PrevMonth"><i class="bi bi-chevron-left"></i></button>
            <span class="current-month">@CurrentDate.ToString("MMMM yyyy")</span>
            <button class="nav-btn" @onclick="NextMonth"><i class="bi bi-chevron-right"></i></button>
        </div>
    </div>

    <!-- 2. The Grid -->
    <div class="calendar-card">
        
        <!-- Day Names Header -->
        <div class="days-header">
            <span>SU</span><span>MO</span><span>TU</span><span>WE</span><span>TH</span><span>FR</span><span>SA</span>
        </div>

        <!-- Days Grid -->
        <div class="days-grid">
            
            <!-- Empty slots for padding (e.g. if month starts on Wednesday) -->
            @for (int i = 0; i < StartOffset; i++)
            {
                <div class="day-cell empty"></div>
            }

            <!-- Real Days -->
            @for (int day = 1; day <= DaysInMonth; day++)
            {
                // Capture the date for this cell
                DateTime cellDate = new DateTime(CurrentDate.Year, CurrentDate.Month, day);
                
                // Check if user has written on this day
                bool hasEntry = EntryDates.Contains(cellDate.Date);
                
                // Check if this cell is Today
                bool isToday = cellDate.Date == DateTime.Today;

                <div class="day-cell @(isToday ? "today" : "")" @onclick="() => OpenEntry(cellDate)">
                    <span class="day-number">@day</span>
                    
                    @if (hasEntry)
                    {
                        <span class="dot"></span>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    private DateTime CurrentDate = DateTime.Today;
    private int DaysInMonth;
    private int StartOffset;
    private HashSet<DateTime> EntryDates = new HashSet<DateTime>(); // Fast lookup for dots

    protected override async Task OnInitializedAsync()
    {
        await LoadMonthData();
    }

    private async Task LoadMonthData()
    {
        // 1. Calculate Grid Math
        DaysInMonth = DateTime.DaysInMonth(CurrentDate.Year, CurrentDate.Month);
        var firstDay = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        StartOffset = (int)firstDay.DayOfWeek; // 0 = Sunday, 1 = Monday...

        // 2. Get Data for Dots
        // We get ALL entries, then filter locally. 
        // (For a massive app, you'd filter in SQL, but for this assignment, this is fine).
        var allEntries = await DbService.GetAllEntriesAsync();
        
        // Store just the dates that have entries
        EntryDates = allEntries.Select(e => e.EntryDate.Date).ToHashSet();
    }

    private async Task PrevMonth()
    {
        CurrentDate = CurrentDate.AddMonths(-1);
        await LoadMonthData();
    }

    private async Task NextMonth()
    {
        CurrentDate = CurrentDate.AddMonths(1);
        await LoadMonthData();
    }

    private void OpenEntry(DateTime date)
    {
        // Navigate to Journal page with the specific date query
        // Format: /journal?date=2026-01-24
        string dateString = date.ToString("yyyy-MM-dd");
        Nav.NavigateTo($"journal?date={dateString}");
    }
}

<style>
    .calendar-wrapper {
        padding: 40px;
        max-width: 900px;
        margin: 0 auto;
        color: #1A1A1A;
        font-family: 'Poppins', sans-serif;
    }

    /* Header */
    .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    .page-title { font-weight: 800; font-size: 2.5rem; margin: 0; }

    .month-selector {
        background: white;
        padding: 10px 20px;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        display: flex; align-items: center; gap: 20px;
        border: 1px solid #EEE;
    }
    .current-month { font-weight: 700; font-size: 1.1rem; min-width: 140px; text-align: center; }
    .nav-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #1A1A1A; }
    .nav-btn:hover { color: #888; }

    /* The Calendar Card */
    .calendar-card {
        background: white;
        border-radius: 24px;
        padding: 40px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.05);
        border: 1px solid #F0F0F0;
    }

    /* Headers (Su, Mo, Tu...) */
    .days-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #F5F5F5;
        padding-bottom: 15px;
    }
    .days-header span {
        font-size: 0.8rem;
        font-weight: 700;
        color: #999;
        letter-spacing: 1px;
    }

    /* The Grid */
    .days-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        row-gap: 20px;
        column-gap: 10px;
    }

    /* Day Cell */
    .day-cell {
        height: 80px; /* Big touch targets */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    .day-cell:hover { background-color: #F9F9F9; }
    
    .day-number { font-size: 1.2rem; font-weight: 600; color: #333; }
    
    /* Today Styling */
    .day-cell.today {
        background-color: #1A1A1A;
        color: white;
    }
    .day-cell.today .day-number { color: white; }

    /* The Dot (Entry Indicator) */
    .dot {
        width: 6px; height: 6px;
        background-color: #1A1A1A; /* Black dot */
        border-radius: 50%;
        margin-top: 6px;
    }
    .day-cell.today .dot { background-color: white; } /* White dot on black bg */

    .day-cell.empty { cursor: default; pointer-events: none; }
</style>