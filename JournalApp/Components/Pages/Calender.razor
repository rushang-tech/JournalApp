@page "/calendar"
@using System.Globalization
@using JournalApp.Services
@using JournalApp.Models
@inject JournalService DbService
@inject ThemeService Theme
@inject NavigationManager Nav
@implements IDisposable

<div class="calendar-wrapper">
    
    <!-- 1. Header (Month Navigation) -->
    <div class="header-row">
        <h1 class="page-title">Calendar</h1>
        
        <div class="month-selector">
            <button class="nav-btn" @onclick="PrevMonth"><i class="bi bi-chevron-left"></i></button>
            <span class="current-month">@CurrentDate.ToString("MMMM yyyy")</span>
            <button class="nav-btn" @onclick="NextMonth"><i class="bi bi-chevron-right"></i></button>
        </div>
    </div>

    <!-- 2. The Grid -->
    <div class="calendar-card">
        
        <!-- Day Names Header -->
        <div class="days-header">
            <span>SU</span><span>MO</span><span>TU</span><span>WE</span><span>TH</span><span>FR</span><span>SA</span>
        </div>

        <!-- Days Grid -->
        <div class="days-grid">
            
            <!-- Empty slots for padding -->
            @for (int i = 0; i < StartOffset; i++)
            {
                <div class="day-cell empty"></div>
            }

            <!-- Real Days -->
            @for (int day = 1; day <= DaysInMonth; day++)
            {
                DateTime cellDate = new DateTime(CurrentDate.Year, CurrentDate.Month, day);
                bool hasEntry = EntryDates.Contains(cellDate.Date);
                bool isToday = cellDate.Date == DateTime.Today;

                <div class="day-cell @(isToday ? "today" : "")" @onclick="() => OpenEntry(cellDate)">
                    <span class="day-number">@day</span>
                    
                    @if (hasEntry)
                    {
                        <span class="dot"></span>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    private DateTime CurrentDate = DateTime.Today;
    private int DaysInMonth;
    private int StartOffset;
    private HashSet<DateTime> EntryDates = new HashSet<DateTime>();

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to theme changes so dots/colors update instantly
        Theme.OnThemeChanged += StateHasChanged;
        await LoadMonthData();
    }

    public void Dispose()
    {
        // Unsubscribe when leaving page
        Theme.OnThemeChanged -= StateHasChanged;
    }

    private async Task LoadMonthData()
    {
        DaysInMonth = DateTime.DaysInMonth(CurrentDate.Year, CurrentDate.Month);
        var firstDay = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        StartOffset = (int)firstDay.DayOfWeek;

        var allEntries = await DbService.GetAllEntriesAsync();
        EntryDates = allEntries.Select(e => e.EntryDate.Date).ToHashSet();
    }

    private async Task PrevMonth()
    {
        CurrentDate = CurrentDate.AddMonths(-1);
        await LoadMonthData();
    }

    private async Task NextMonth()
    {
        CurrentDate = CurrentDate.AddMonths(1);
        await LoadMonthData();
    }

    private void OpenEntry(DateTime date)
    {
        // Navigation logic: Takes user to the journal entry for this specific date
        string dateString = date.ToString("yyyy-MM-dd");
        Nav.NavigateTo($"journal?date={dateString}");
    }
}

<style>
    .calendar-wrapper {
        padding: 40px;
        max-width: 900px;
        margin: 0 auto;
        /* Use theme variable for text */
        color: var(--text-primary);
        font-family: 'Poppins', sans-serif;
    }

    /* Header */
    .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    .page-title { font-weight: 800; font-size: 2.5rem; margin: 0; color: var(--text-primary); }

    .month-selector {
        background: var(--bg-secondary);
        padding: 10px 20px;
        border-radius: 50px;
        box-shadow: 0 4px 15px var(--shadow-color);
        display: flex; align-items: center; gap: 20px;
        border: 1px solid var(--border-color);
    }
    .current-month { font-weight: 700; font-size: 1.1rem; min-width: 140px; text-align: center; color: var(--text-primary); }
    .nav-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-primary); }
    .nav-btn:hover { opacity: 0.6; }

    /* The Calendar Card */
    .calendar-card {
        background: var(--bg-secondary);
        border-radius: 24px;
        padding: 40px;
        box-shadow: 0 10px 40px var(--shadow-color);
        border: 1px solid var(--border-color);
    }

    /* Headers (Su, Mo, Tu...) */
    .days-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
    }
    .days-header span {
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--text-muted);
        letter-spacing: 1px;
    }

    /* The Grid */
    .days-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        row-gap: 20px;
        column-gap: 10px;
    }

    /* Day Cell */
    .day-cell {
        height: 80px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        color: var(--text-primary);
    }
    .day-cell:hover { background-color: var(--hover-bg); }
    
    .day-number { font-size: 1.2rem; font-weight: 600; }
    
    /* Today Styling */
    .day-cell.today {
        background-color: var(--accent-color);
        color: var(--accent-text);
    }

    /* The Dot (Entry Indicator) - FIXED for Dark Mode */
    .dot {
        width: 7px; height: 7px;
        /* Dot will be black in light mode, white in dark mode */
        background-color: var(--text-primary); 
        border-radius: 50%;
        margin-top: 6px;
        transition: transform 0.2s ease;
    }
    .day-cell:hover .dot { transform: scale(1.3); }
    .day-cell.today .dot { background-color: var(--accent-text); } 

    .day-cell.empty { cursor: default; pointer-events: none; }
</style>